import { useEffect, useMemo, useState } from "react";
import { Card, DatePicker, Button, Modal, Form, Input, Typography, message, Tag, Tooltip, Space, Calendar, Badge, Spin, ConfigProvider, Alert, Divider, Radio, Select, InputNumber } from "antd";
import type { BadgeProps, TagProps } from "antd";
import viVN from "antd/locale/vi_VN";
import type { Dayjs } from "dayjs";
import dayjs from "dayjs";
import axiosInstance from "../../services/constant/axiosInstance";
import { TECHNICIAN_SCHEDULES_BY_TECHNICIAN_ENDPOINT } from "../../services/constant/apiConfig";
import { useAppSelector, useAppDispatch } from "../../services/store/store";
import {
    createWorkProgress,
    getProgressByAppointment,
    submitInspectionQuote as submitInspectionQuoteThunk,
    startMaintenance as startMaintenanceThunk,
    completeMaintenance,
} from "../../services/features/technician/workProgressSlice";
import { cancelBooking } from "../../services/features/booking/bookingSlice";
import { TechnicianSchedule } from "@/interfaces/technician";
import { WorkProgress } from "@/interfaces/workProgress";
import { fetchParts, fetchPartsByCategory } from "../../services/features/parts/partsSlice";

const { TextArea } = Input;
const { Title, Text } = Typography;



export default function TechnicianWorkProgressPage() {
    const { user } = useAppSelector((s) => s.auth);
    const technicianId = user?.id || "";
    const dispatch = useAppDispatch();

    dayjs.locale("vi");
    const [currentMonth, setCurrentMonth] = useState<Dayjs>(dayjs());
    // const [today] = useState<Dayjs>(dayjs());
    const [dayModalOpen, setDayModalOpen] = useState(false);
    const [selectedDay, setSelectedDay] = useState<Dayjs | null>(null);
    const [loading, setLoading] = useState(false);
    type ScheduleLike = TechnicianSchedule & { appointmentId?: string };
    const [schedules, setSchedules] = useState<ScheduleLike[]>([]);
    const [selectedAppointmentId, setSelectedAppointmentId] = useState<string | null>(null);
    const [createOpen, setCreateOpen] = useState(false);
    const [form] = Form.useForm();
    const [detailOpen, setDetailOpen] = useState(false);
    const [detailLoading, setDetailLoading] = useState(false);
    const [detailSchedule, setDetailSchedule] = useState<ScheduleLike | null>(null);
    const [detailProgress, setDetailProgress] = useState<WorkProgress | null>(null);
    const [detailSelectedAppointmentId, setDetailSelectedAppointmentId] = useState<string | null>(null);
    const [quoteOpen, setQuoteOpen] = useState(false);
    const [quoteForm] = Form.useForm();
    const [completeOpen, setCompleteOpen] = useState(false);
    const [completeForm] = Form.useForm();
    const [progressExistSet, setProgressExistSet] = useState<Set<string>>(new Set());
    const [dayModalSelectedAppt, setDayModalSelectedAppt] = useState<Record<string, string>>({});
    const { parts: allParts, loading: partsLoading } = useAppSelector((s) => s.parts);
    const [selectedPartCategory, setSelectedPartCategory] = useState<string | undefined>(undefined);

    // Cancel booking state
    const [cancelOpen, setCancelOpen] = useState(false);
    const [cancelReason, setCancelReason] = useState("");
    const [selectedBookingForCancel, setSelectedBookingForCancel] = useState<string | null>(null);

    const startDate = useMemo(() => currentMonth.startOf("month").format("YYYY-MM-DD"), [currentMonth]);
    const endDate = useMemo(() => currentMonth.endOf("month").format("YYYY-MM-DD"), [currentMonth]);

    const schedulesByDate = useMemo(() => {
        const map: Record<string, ScheduleLike[]> = {};
        schedules.forEach((sch) => {
            const key = dayjs(sch.workDate).format("YYYY-MM-DD");
            if (!map[key]) map[key] = [];
            map[key].push(sch);
        });
        return map;
    }, [schedules]);

    const loadSchedules = async () => {
        if (!technicianId) return;
        setLoading(true);
        try {
            const res = await axiosInstance.get(
                TECHNICIAN_SCHEDULES_BY_TECHNICIAN_ENDPOINT(technicianId),
                { params: { startDate, endDate } }
            );
            const data = res.data?.data || res.data;
            const list = Array.isArray(data) ? (data as ScheduleLike[]) : [];
            setSchedules(list);
            // Build set of appointmentIds that already have progress
            const ids = list
                .map((s) => s.appointmentId || s.assignedAppointments?.[0]?._id)
                .filter((x): x is string => typeof x === 'string');
            const checks = await Promise.allSettled(ids.map((id) => dispatch(getProgressByAppointment(id))));
            const exist = new Set<string>();
            checks.forEach((r, i) => {
                if (r.status === 'fulfilled') {
                    const action = r.value;
                    if (getProgressByAppointment.fulfilled.match(action) && (action.payload as { success?: boolean })?.success) {
                        exist.add(ids[i]);
                    }
                }
            });
            setProgressExistSet(exist);
        } catch {
            setSchedules([]);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        loadSchedules();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [technicianId, startDate, endDate]);

    // Load parts list when opening quote modal (for items selection)
    useEffect(() => {
        if (quoteOpen && (!allParts || allParts.length === 0)) {
            dispatch(fetchParts(undefined));
        }
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [quoteOpen]);

    const categoryOptions = useMemo(() => {
        const set = new Set<string>();
        (allParts || []).forEach((p) => {
            if (p?.category) set.add(p.category);
        });
        return Array.from(set).sort().map((c) => ({ label: c, value: c }));
    }, [allParts]);

    const handleSelectCategory = (category?: string) => {
        setSelectedPartCategory(category);
        if (!category) {
            dispatch(fetchParts(undefined));
        } else {
            dispatch(fetchPartsByCategory(category));
        }
    };

    const handleSelectPartForItem = (itemIndex: number, partId: string) => {
        const part = (allParts || []).find((p) => p._id === partId);
        const currentQuote = quoteForm.getFieldValue(["quoteDetails"]) || {} as { items?: Array<{ partId?: string; name?: string; unitPrice?: number; quantity?: number }> };
        const items: Array<{ partId?: string; name?: string; unitPrice?: number; quantity?: number }> = Array.isArray(currentQuote.items) ? [...currentQuote.items] : [];
        const existing = items[itemIndex] || {};
        items[itemIndex] = {
            ...existing,
            partId,
            name: existing.name ?? part?.partName ?? "",
            unitPrice: part?.unitPrice ?? existing.unitPrice ?? 0,
            quantity: existing.quantity ?? 1,
        };
        quoteForm.setFieldsValue({ quoteDetails: { ...currentQuote, items } });
    };

    const ensureProgressChecked = async (appointmentId: string): Promise<boolean> => {
        try {
            const action = await dispatch(getProgressByAppointment(appointmentId));
            if (getProgressByAppointment.fulfilled.match(action) && (action.payload as { success?: boolean })?.success) {
                setProgressExistSet((prev) => new Set(prev).add(appointmentId));
                return true;
            }
            // Not found or no success
            setProgressExistSet((prev) => {
                const copy = new Set(prev);
                copy.delete(appointmentId);
                return copy;
            });
            return false;
        } catch {
            return false;
        }
    };

    const statusColor = (status?: string) =>
        status === "working"
            ? "processing"
            : status === "completed"
                ? "success"
                : status === "on_leave"
                    ? "warning"
                    : status === "absent"
                        ? "error"
                        : "default";

    const dateCellRender = (value: Dayjs) => {
        const key = value.format("YYYY-MM-DD");
        const items = schedulesByDate[key] || [];
        if (!items.length) return null;
        return (
            <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                {items.map((item) => (
                    <li key={item._id} style={{ whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12 }}>
                            <Badge status={statusColor(item.status) as BadgeProps['status']} text={`${item.shiftStart}-${item.shiftEnd}`} />
                            {Array.isArray(item.assignedAppointments) && item.assignedAppointments.some((a) => a.status !== 'cancelled') && (
                                <Tooltip title="CÃ³ booking">
                                    <span style={{ width: 6, height: 6, background: '#1677ff', borderRadius: '50%', display: 'inline-block' }} />
                                </Tooltip>
                            )}
                        </div>
                    </li>
                ))}
            </ul>
        );
    };

    const onPanelChange = (value: Dayjs) => {
        setCurrentMonth(value);
    };

    const onSelectDate = (value: Dayjs) => {
        const key = value.format("YYYY-MM-DD");
        const items = schedulesByDate[key] || [];
        if (!items.length) return;
        setSelectedDay(value);
        setDayModalOpen(true);
    };

    const openCreateProgress = async (schedule: ScheduleLike, explicitAppointmentId?: string) => {
        const apptId = explicitAppointmentId || schedule.appointmentId || schedule.assignedAppointments?.[0]?._id || null;
        setSelectedAppointmentId(apptId);
        if (!apptId) {
            message.warning("Lá»ch nÃ y chÆ°a gáº¯n booking - khÃ´ng thá» táº¡o tiáº¿n trÃ¬nh");
            return;
        }
        const existed = await ensureProgressChecked(apptId);
        if (existed) {
            message.info("Booking ÄÃ£ cÃ³ tiáº¿n trÃ¬nh.");
            return;
        }
        // Prefill serviceDate and startTime from booking if available
        let serviceDateValue: dayjs.Dayjs | undefined;
        let startTimeValue: dayjs.Dayjs | undefined;
        const selectedAppt = schedule.assignedAppointments?.find((a) => a._id === apptId) || schedule.assignedAppointments?.[0];
        const aTime = selectedAppt?.appointmentTime as { date?: string; startTime?: string } | undefined;
        const dateISO = aTime?.date || schedule.workDate;
        if (dateISO) {
            serviceDateValue = dayjs(dateISO);
            const start = aTime?.startTime;
            if (start) {
                const [hh, mm] = start.split(":");
                startTimeValue = dayjs(dateISO).hour(Number(hh || 0)).minute(Number(mm || 0)).second(0).millisecond(0);
            }
        }
        form.resetFields();
        form.setFieldsValue({
            serviceDate: serviceDateValue,
            startTime: startTimeValue,
            milestones: [],
        });
        setCreateOpen(true);
    };

    const getAppointmentIdFromSchedule = (sch: ScheduleLike): string | null => {
        return sch.appointmentId || sch.assignedAppointments?.[0]?._id || null;
    };

    const openDetails = async (sch: ScheduleLike) => {
        setDetailSchedule(sch);
        setDetailOpen(true);
        setDetailLoading(true);
        setDetailProgress(null);
        // preselect first assigned appointment if available
        const firstNonCancelled = Array.isArray(sch.assignedAppointments)
            ? sch.assignedAppointments.find((a) => a.status !== 'cancelled')?._id
            : undefined;
        const apptPreset = firstNonCancelled || sch.appointmentId || null;
        setDetailSelectedAppointmentId(typeof apptPreset === 'string' ? apptPreset : null);
        try {
            const apptId = (firstNonCancelled as string | undefined) || getAppointmentIdFromSchedule(sch);
            if (apptId) {
                const result = await dispatch(getProgressByAppointment(apptId));
                if (getProgressByAppointment.fulfilled.match(result) && result.payload.success) {
                    setDetailProgress(result.payload.data as WorkProgress);
                }
            }
        } finally {
            setDetailLoading(false);
        }
    };

    const onChangeDetailAppointment = async (appointmentId: string) => {
        setDetailSelectedAppointmentId(appointmentId);
        setDetailLoading(true);
        setDetailProgress(null);
        try {
            const result = await dispatch(getProgressByAppointment(appointmentId));
            if (getProgressByAppointment.fulfilled.match(result) && result.payload.success) {
                setDetailProgress(result.payload.data as WorkProgress);
            }
        } finally {
            setDetailLoading(false);
        }
    };



    const submitInspectionQuote = async () => {
        try {
            const values = await quoteForm.validateFields();
            const progressId = detailProgress?._id;
            if (!progressId) return;
            // Build payload without quoteAmount and without labor
            type QuoteItemForm = { partId?: string; quantity?: number; unitPrice?: number; name?: string };
            const itemsSource: QuoteItemForm[] = Array.isArray(values?.quoteDetails?.items)
                ? (values.quoteDetails.items as QuoteItemForm[])
                : [];
            const items = itemsSource
                .filter((it) => !!it?.partId)
                .map((it) => ({
                    partId: it.partId as string,
                    quantity: Number(it?.quantity || 0),
                    unitPrice: Number(it?.unitPrice || 0),
                    name: it?.name,
                }));
            const result = await dispatch(
                submitInspectionQuoteThunk({
                    progressId,
                    payload: {
                        vehicleCondition: values.vehicleCondition,
                        diagnosisDetails: values.diagnosisDetails,
                        inspectionNotes: values.inspectionNotes,
                        quoteDetails: { items },
                    },
                })
            );
            if (submitInspectionQuoteThunk.fulfilled.match(result) && (result.payload as { success?: boolean })?.success) {
                message.success("ÄÃ£ gá»­i bÃ¡o giÃ¡");
                setQuoteOpen(false);
            } else {
                const payload = result.payload as unknown;
                const errMsg = (typeof payload === 'string' ? payload : (payload as { message?: string })?.message) || "Gá»­i bÃ¡o giÃ¡ tháº¥t báº¡i";
                message.error(String(errMsg));
            }
            await openDetails(detailSchedule as ScheduleLike);
        } catch {
            // validation or request error
        }
    };

    const startMaintenance = async () => {
        try {
            const progressId = detailProgress?._id;
            if (!progressId) return;
            const result = await dispatch(startMaintenanceThunk(progressId));
            if (startMaintenanceThunk.fulfilled.match(result) && (result.payload as { success?: boolean })?.success) {
                message.success("Báº¯t Äáº§u báº£o dÆ°á»¡ng");
            } else {
                const payload = result.payload as unknown;
                const errMsg = (typeof payload === 'string' ? payload : (payload as { message?: string })?.message) || "KhÃ´ng thá» báº¯t Äáº§u báº£o dÆ°á»¡ng";
                message.error(String(errMsg));
            }
            await openDetails(detailSchedule as ScheduleLike);
        } catch {
            message.error("KhÃ´ng thá» báº¯t Äáº§u báº£o dÆ°á»¡ng");
        }
    };

    const submitComplete = async () => {
        try {
            const values = await completeForm.validateFields();
            const progressId = detailProgress?._id;
            if (!progressId) return;
            const result = await dispatch(completeMaintenance({ progressId, payload: values }));
            if (completeMaintenance.fulfilled.match(result) && (result.payload as { success?: boolean })?.success) {
                message.success("ÄÃ£ hoÃ n thÃ nh báº£o dÆ°á»¡ng");
                setCompleteOpen(false);
            } else {
                const payload = result.payload as unknown;
                const errMsg = (typeof payload === 'string' ? payload : (payload as { message?: string })?.message) || "HoÃ n thÃ nh tháº¥t báº¡i";
                message.error(String(errMsg));
            }
            await openDetails(detailSchedule as ScheduleLike);
        } catch {
            message.error("HoÃ n thÃ nh tháº¥t báº¡i");
        }
    };

    const openCancelBooking = (appointmentId: string) => {
        setSelectedBookingForCancel(appointmentId);
        setCancelReason("");
        setCancelOpen(true);
    };

    const closeCancelBooking = () => {
        setCancelOpen(false);
        setSelectedBookingForCancel(null);
        setCancelReason("");
    };

    const submitCancelBooking = async () => {
        if (!selectedBookingForCancel) return;
        try {
            const result = await dispatch(cancelBooking({
                bookingId: selectedBookingForCancel,
                reason: cancelReason
            }));
            if (cancelBooking.fulfilled.match(result)) {
                message.success("ÄÃ£ há»§y lá»ch háº¹n thÃ nh cÃ´ng");
                closeCancelBooking();
                // Reload schedules to reflect the cancellation
                await loadSchedules();
                // Close detail modal if open
                setDetailOpen(false);
            } else {
                const payload = result.payload as unknown;
                const errMsg = (typeof payload === 'string' ? payload : (payload as { message?: string })?.message) || "Há»§y lá»ch háº¹n tháº¥t báº¡i";
                message.error(String(errMsg));
            }
        } catch {
            message.error("Há»§y lá»ch háº¹n tháº¥t báº¡i");
        }
    };

    const handleCreate = async () => {
        try {
            const values = await form.validateFields();
            if (!selectedAppointmentId || !technicianId) return;
            const existed = await ensureProgressChecked(selectedAppointmentId);
            if (existed) {
                message.info("Booking ÄÃ£ cÃ³ tiáº¿n trÃ¬nh.");
                setCreateOpen(false);
                return;
            }
            const payload = {
                technicianId,
                appointmentId: selectedAppointmentId,
                serviceDate: values.serviceDate?.toISOString?.() || new Date().toISOString(),
                startTime: values.startTime?.toISOString?.() || new Date().toISOString(),
                milestones: (values.milestones || []).map((m: { name: string; description: string }) => ({ name: m.name, description: m.description })),
                notes: values.notes || "",
            };
            const result = await dispatch(createWorkProgress(payload));
            if (createWorkProgress.fulfilled.match(result) && (result.payload as { success?: boolean })?.success) {
                message.success("Táº¡o tiáº¿n trÃ¬nh thÃ nh cÃ´ng");
                setCreateOpen(false);
                setProgressExistSet((prev) => new Set(prev).add(selectedAppointmentId));
            } else {
                const payload = result.payload as unknown;
                const errMsg = (typeof payload === 'string' ? payload : (payload as { message?: string })?.message) || "Táº¡o tiáº¿n trÃ¬nh tháº¥t báº¡i";
                message.error(String(errMsg));
            }
        } catch {
            // validation error or request failed
        }
    };

    return (
        <div className="p-6">
            <div className="mb-6">
                <Title level={2}>Tiáº¿n Äá» lÃ m viá»c ká»¹ thuáº­t viÃªn</Title>
                <Space size={8} wrap>
                    <Badge status="processing" text="Äang lÃ m" />
                    <Badge status="success" text="HoÃ n táº¥t" />
                    <Badge status="warning" text="Nghá» phÃ©p" />
                    <Badge status="error" text="Váº¯ng" />
                    <Badge status="default" text="Lá»ch" />
                </Space>
            </div>

            <Spin spinning={loading}>
                <ConfigProvider locale={viVN}>
                    <Card>
                        <div className="flex justify-between items-center mb-3">
                            <Space>
                                <Button onClick={() => setCurrentMonth(dayjs())}>HÃ´m nay</Button>
                                <Button onClick={loadSchedules} loading={loading}>Táº£i láº¡i</Button>
                            </Space>
                            <Text type="secondary">Khoáº£ng: {dayjs(startDate).format("DD/MM/YYYY")} - {dayjs(endDate).format("DD/MM/YYYY")}</Text>
                        </div>
                        <Calendar
                            value={currentMonth}
                            onPanelChange={onPanelChange}
                            dateCellRender={dateCellRender}
                            onSelect={onSelectDate}
                        />
                    </Card>
                </ConfigProvider>
            </Spin>

            <Modal
                title="Chi tiáº¿t lá»ch/booking"
                open={detailOpen}
                onCancel={() => setDetailOpen(false)}
                footer={null}
                width={720}
            >
                {detailLoading ? (
                    <div className="py-6">Äang táº£i...</div>
                ) : (
                    <div className="space-y-4">
                        <div className="flex items-center gap-2 text-sm text-gray-600">
                            <span>NgÃ y:</span>
                            <span className="font-medium">{dayjs(detailSchedule?.workDate || startDate).format("DD/MM/YYYY")}</span>
                            <span>â¢ Ca:</span>
                            <span className="font-medium">{detailSchedule?.shiftStart} - {detailSchedule?.shiftEnd}</span>
                        </div>
                        <div className="border-t pt-3">
                            <Space wrap>
                                {null}
                                {detailProgress && (
                                    <>
                                        <Button onClick={() => { quoteForm.resetFields(); setQuoteOpen(true); }} disabled={(() => {
                                            const progressStatus = detailProgress?.currentStatus || '';
                                            const currentAppt = (detailSchedule && Array.isArray(detailSchedule.assignedAppointments))
                                                ? (detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId) || detailSchedule.assignedAppointments[0])
                                                : undefined;
                                            const apptStatus = currentAppt?.status || '';
                                            // Disable if appointment itself is completed
                                            if (apptStatus === 'completed') return true;
                                            // If progress is completed but appointment is maintenance_completed, allow sending again
                                            if (progressStatus === 'completed' && apptStatus === 'maintenance_completed') return false;
                                            // Otherwise disable only when progress is completed
                                            return progressStatus === 'completed';
                                        })()}>Gá»­i Inspection & Quote</Button>
                                        {(() => {
                                            const status = detailProgress?.currentStatus || '';
                                            const maintenanceStartedOrBeyond = ['in_progress', 'paused', 'completed', 'delayed'].includes(status);
                                            const quoteApproved = detailProgress?.quote?.quoteStatus === 'approved'
                                                || (typeof detailProgress?.appointmentId === 'object' && detailProgress?.appointmentId?.inspectionAndQuote?.quoteStatus === 'approved')
                                                || status === 'quote_provided';
                                            const canStart = !maintenanceStartedOrBeyond && !!quoteApproved;
                                            return (
                                                <Button onClick={startMaintenance} disabled={!canStart}>Báº¯t Äáº§u báº£o dÆ°á»¡ng</Button>
                                            );
                                        })()}
                                        <Button danger onClick={() => { completeForm.resetFields(); setCompleteOpen(true); }} disabled={detailProgress?.currentStatus !== 'in_progress'}>HoÃ n thÃ nh</Button>
                                    </>
                                )}
                                {/* Cancel booking button - show for all appointments that can be cancelled */}
                                {detailSelectedAppointmentId && (() => {
                                    const currentAppt = (detailSchedule && Array.isArray(detailSchedule.assignedAppointments))
                                        ? (detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId) || detailSchedule.assignedAppointments[0])
                                        : undefined;
                                    const apptStatus = currentAppt?.status || '';
                                    // Allow cancellation for most statuses except completed and cancelled
                                    const canCancel = !['completed', 'cancelled'].includes(apptStatus);
                                    return canCancel ? (
                                        <Button
                                            danger
                                            onClick={() => openCancelBooking(detailSelectedAppointmentId)}
                                        >
                                            Há»§y lá»ch háº¹n
                                        </Button>
                                    ) : null;
                                })()}
                            </Space>
                        </div>
                        {/* Chá»n booking náº¿u cÃ³ nhiá»u */}
                        {detailSchedule && Array.isArray(detailSchedule.assignedAppointments) && detailSchedule.assignedAppointments.some((a) => a.status !== 'cancelled') && (
                            <div className="bg-gray-50 p-3 rounded border">
                                <div className="mb-2 text-sm text-gray-600">Chá»n booking theo giá» háº¹n</div>
                                <Radio.Group
                                    value={detailSelectedAppointmentId || undefined}
                                    onChange={(e) => onChangeDetailAppointment(e.target.value)}
                                >
                                    <Space direction="vertical">
                                        {detailSchedule.assignedAppointments.filter((a) => a.status !== 'cancelled').map((a) => (
                                            <Radio key={a._id} value={a._id}>
                                                {(a.appointmentTime?.startTime || '')}{a.appointmentTime?.endTime ? ` - ${a.appointmentTime.endTime}` : ''}
                                                {a.status ? ` â¢ ${a.status}` : ''}
                                            </Radio>
                                        ))}
                                    </Space>
                                </Radio.Group>
                            </div>
                        )}
                        {detailSchedule && Array.isArray(detailSchedule.assignedAppointments) && detailSchedule.assignedAppointments.some((a) => a.status !== 'cancelled') && (
                            <div className="bg-gray-50 p-3 rounded border">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <p className="text-gray-500">Giá» háº¹n</p>
                                        <p className="font-medium">
                                            {(() => {
                                                const current = detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId && a.status !== 'cancelled')
                                                    || detailSchedule.assignedAppointments.find(a => a.status !== 'cancelled');
                                                return `${current?.appointmentTime?.startTime || ''}${current?.appointmentTime?.endTime ? ` - ${current.appointmentTime.endTime}` : ''}`;
                                            })()}
                                        </p>
                                    </div>
                                    <div>
                                        <p className="text-gray-500">Quote status</p>
                                        <p className="font-medium">{(() => {
                                            const current = detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId && a.status !== 'cancelled')
                                                || detailSchedule.assignedAppointments.find(a => a.status !== 'cancelled');
                                            return current?.inspectionAndQuote?.quoteStatus || 'pending';
                                        })()}</p>
                                    </div>
                                    <div>
                                        <p className="text-gray-500">Payment</p>
                                        <p className="font-medium">{(() => {
                                            const current = detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId && a.status !== 'cancelled')
                                                || detailSchedule.assignedAppointments.find(a => a.status !== 'cancelled');
                                            return current?.payment?.status || 'â';
                                        })()}</p>
                                    </div>
                                    <div className="md:col-span-2">
                                        <p className="text-gray-500">MÃ´ táº£</p>
                                        <p className="font-medium break-words">{(() => {
                                            const current = detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId && a.status !== 'cancelled')
                                                || detailSchedule.assignedAppointments.find(a => a.status !== 'cancelled');
                                            return current?.serviceDetails?.description || 'â';
                                        })()}</p>
                                    </div>
                                    <div>
                                        <p className="text-gray-500">XÃ¡c nháº­n</p>
                                        <p className="font-medium">{(() => {
                                            const current = detailSchedule.assignedAppointments.find(a => a._id === detailSelectedAppointmentId && a.status !== 'cancelled')
                                                || detailSchedule.assignedAppointments.find(a => a.status !== 'cancelled');
                                            return current?.confirmation?.isConfirmed ? 'ÄÃ£ xÃ¡c nháº­n' : 'ChÆ°a xÃ¡c nháº­n';
                                        })()}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                        {!detailProgress && (
                            <div className="bg-gray-50 p-3 rounded border">
                                <p className="text-gray-600">ChÆ°a cÃ³ tiáº¿n trÃ¬nh cho lá»ch nÃ y. Nháº¥n "Táº¡o tiáº¿n trÃ¬nh" Äá» báº¯t Äáº§u.</p>
                            </div>
                        )}
                        {detailProgress && (
                            <div className="bg-gray-50 p-3 rounded border">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <p className="text-gray-500">Tráº¡ng thÃ¡i hiá»n táº¡i</p>
                                        <p className="font-medium">{(detailProgress.currentStatus || '').split('_').join(' ')}</p>
                                    </div>
                                    <div>
                                        <p className="text-gray-500">Quote status</p>
                                        <p className="font-medium">{detailProgress?.quote?.quoteStatus || (typeof detailProgress?.appointmentId === 'object' && detailProgress?.appointmentId?.inspectionAndQuote?.quoteStatus) || 'pending'}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </Modal>

            <Modal
                open={dayModalOpen}
                title={selectedDay ? `Lá»ch ngÃ y ${selectedDay.format("DD/MM/YYYY")}` : "Lá»ch trong ngÃ y"}
                onCancel={() => setDayModalOpen(false)}
                footer={<Button onClick={() => setDayModalOpen(false)}>ÄÃ³ng</Button>}
            >
                {selectedDay ? (
                    (() => {
                        const key = selectedDay.format("YYYY-MM-DD");
                        const items = (schedulesByDate[key] || []).map((it) => ({
                            ...it,
                            assignedAppointments: Array.isArray(it.assignedAppointments)
                                ? it.assignedAppointments.filter((a) => a.status !== 'cancelled')
                                : it.assignedAppointments,
                        }));
                        if (!items.length) return <Alert type="info" message="KhÃ´ng cÃ³ lá»ch trong ngÃ y nÃ y" showIcon />;
                        return (
                            <Space direction="vertical" style={{ width: "100%" }}>
                                {items.map((item) => {
                                    const apptId = item.appointmentId || (item.assignedAppointments?.[0]?._id as string | undefined);
                                    const hasBooking = !!apptId;
                                    return (
                                        <Card key={item._id} size="small">
                                            <Space split={<Divider type="vertical" />} wrap>
                                                <Tag color={statusColor(item.status) as TagProps['color']}>{item.status}</Tag>
                                                <Text>{`${item.shiftStart} - ${item.shiftEnd}`}</Text>
                                                {item.centerId?.name && (
                                                    <Text type="secondary">{item.centerId.name}</Text>
                                                )}
                                                {Array.isArray(item.assignedAppointments) && item.assignedAppointments.length > 0 && (
                                                    <>
                                                        <Tag color="blue">CÃ³ booking</Tag>

                                                    </>
                                                )}
                                            </Space>
                                            <div className="mt-2 flex gap-2 flex-col">
                                                {Array.isArray(item.assignedAppointments) && item.assignedAppointments.length > 1 && (
                                                    <div className="flex items-center gap-2">
                                                        <Text type="secondary">Chá»n giá»:</Text>
                                                        <Radio.Group
                                                            value={dayModalSelectedAppt[item._id] || (item.assignedAppointments?.[0]?._id as string | undefined)}
                                                            onChange={(e) => setDayModalSelectedAppt((prev) => ({ ...prev, [item._id]: e.target.value }))}
                                                        >
                                                            <Space size={4} wrap>
                                                                {item.assignedAppointments.map((a) => (
                                                                    <Radio key={a._id} value={a._id}>
                                                                        {(a.appointmentTime?.startTime || '')}{a.appointmentTime?.endTime ? ` - ${a.appointmentTime.endTime}` : ''}
                                                                    </Radio>
                                                                ))}
                                                            </Space>
                                                        </Radio.Group>
                                                    </div>
                                                )}
                                                <div className="flex gap-2">
                                                    <Button onClick={() => openDetails(item)}>Chi tiáº¿t</Button>
                                                    <Tooltip title={(() => {
                                                        const chosen = dayModalSelectedAppt[item._id] || (item.assignedAppointments?.[0]?._id as string | undefined) || (item.appointmentId as string | undefined);
                                                        const has = chosen ? progressExistSet.has(chosen) : false;
                                                        return has ? "ÄÃ£ cÃ³ tiáº¿n trÃ¬nh cho booking nÃ y" : (hasBooking ? undefined : "Lá»ch nÃ y chÆ°a gáº¯n booking - khÃ´ng thá» táº¡o tiáº¿n trÃ¬nh");
                                                    })()}>
                                                        <Button
                                                            type="primary"
                                                            disabled={!hasBooking || (() => {
                                                                const chosen = dayModalSelectedAppt[item._id] || (item.assignedAppointments?.[0]?._id as string | undefined) || (item.appointmentId as string | undefined);
                                                                return chosen ? progressExistSet.has(chosen) : false;
                                                            })()}
                                                            onClick={() => {
                                                                const chosen = dayModalSelectedAppt[item._id] || (item.assignedAppointments?.[0]?._id as string | undefined) || (item.appointmentId as string | undefined);
                                                                openCreateProgress(item, chosen);
                                                            }}
                                                        >
                                                            Táº¡o tiáº¿n trÃ¬nh
                                                        </Button>
                                                    </Tooltip>
                                                </div>
                                            </div>
                                        </Card>
                                    );
                                })}
                            </Space>
                        );
                    })()
                ) : null}
            </Modal>

            <Modal
                title="Inspection & Quote"
                open={quoteOpen}
                onCancel={() => setQuoteOpen(false)}
                onOk={submitInspectionQuote}
                okText="Gá»­i bÃ¡o giÃ¡"
                width={860}
                destroyOnHidden
            >
                <Form layout="vertical" form={quoteForm} size="small">
                    <Form.Item name="vehicleCondition" label="TÃ¬nh tráº¡ng xe" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
                        <Input placeholder="VÃ­ dá»¥: áº®c quy yáº¿u, ÄÃ¨n bÃ¡o Äá»ng cÆ¡..." />
                    </Form.Item>
                    <Form.Item name="diagnosisDetails" label="Cháº©n ÄoÃ¡n" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
                        <Input placeholder="Chi tiáº¿t cháº©n ÄoÃ¡n" />
                    </Form.Item>
                    <Form.Item name="inspectionNotes" label="Ghi chÃº kiá»m tra" style={{ marginBottom: 8 }}>
                        <Input placeholder="Ghi chÃº" />
                    </Form.Item>
                    {/** Removed GiÃ¡ bÃ¡o (VND) field as it is no longer sent */}
                    <Card size="small" className="mb-3">
                        <div className="flex items-center justify-between">
                            <Typography.Text strong>Háº¡ng má»¥c linh kiá»n</Typography.Text>
                            <Space>
                                <Typography.Text type="secondary">Danh má»¥c:</Typography.Text>
                                <Select
                                    allowClear
                                    placeholder="Táº¥t cáº£"
                                    options={categoryOptions}
                                    loading={partsLoading}
                                    value={selectedPartCategory}
                                    style={{ minWidth: 200 }}
                                    onChange={(v) => handleSelectCategory(v)}
                                />
                            </Space>
                        </div>
                        <Form.List name={["quoteDetails", "items"]}>
                            {(fields, { add, remove }) => (
                                <div className="space-y-2 mt-2 max-h-[320px] overflow-y-auto pr-1">
                                    {fields.map((field) => (
                                        <Card key={field.key} size="small">
                                            <div className="grid grid-cols-1 md:grid-cols-12 gap-2">
                                                <div className="md:col-span-4">
                                                    <Form.Item name={[field.name, "partId"]} label="Linh kiá»n" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
                                                        <Select
                                                            loading={partsLoading}
                                                            showSearch
                                                            optionFilterProp="label"
                                                            placeholder="Chá»n linh kiá»n"
                                                            options={(allParts || []).map((p) => ({ label: `${p.partName} (${p.partNumber})`, value: p._id }))}
                                                            onChange={(v) => handleSelectPartForItem(field.name, v)}
                                                        />
                                                    </Form.Item>
                                                </div>
                                                <div className="md:col-span-4">
                                                    <Form.Item name={[field.name, "name"]} label="TÃªn hiá»n thá»" style={{ marginBottom: 8 }}>
                                                        <Input placeholder="VÃ­ dá»¥: Dáº§u, Lá»c dáº§u" />
                                                    </Form.Item>
                                                </div>
                                                <div className="md:col-span-2">
                                                    <Form.Item name={[field.name, "quantity"]} label="Sá» lÆ°á»£ng" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
                                                        <InputNumber min={1} className="w-full" />
                                                    </Form.Item>
                                                </div>
                                                <div className="md:col-span-2">
                                                    <Form.Item name={[field.name, "unitPrice"]} label="ÄÆ¡n giÃ¡ (VND)" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
                                                        <InputNumber min={0} step={1000} className="w-full" />
                                                    </Form.Item>
                                                </div>
                                            </div>
                                            <div className="flex justify-end">
                                                <Button size="small" type="link" danger onClick={() => remove(field.name)}>XÃ³a má»¥c</Button>
                                            </div>
                                        </Card>
                                    ))}
                                    <Button size="small" type="dashed" onClick={() => add({ quantity: 1, unitPrice: 0 })}>ThÃªm linh kiá»n</Button>
                                </div>
                            )}
                        </Form.List>
                    </Card>
                    {/** Removed CÃ´ng lao Äá»ng UI and will not include in payload */}
                </Form>
            </Modal>

            <Modal
                title="HoÃ n thÃ nh báº£o dÆ°á»¡ng"
                open={completeOpen}
                onCancel={() => setCompleteOpen(false)}
                onOk={submitComplete}
                okText="XÃ¡c nháº­n hoÃ n thÃ nh"
            >
                <Form layout="vertical" form={completeForm}>
                    <Form.Item name="notes" label="Ghi chÃº">
                        <Input.TextArea rows={2} />
                    </Form.Item>
                    <Form.Item name="workDone" label="CÃ´ng viá»c ÄÃ£ lÃ m" rules={[{ required: true }]}>
                        <Input.TextArea rows={2} />
                    </Form.Item>
                    <Form.Item name="recommendations" label="Khuyáº¿n nghá»">
                        <Input.TextArea rows={2} />
                    </Form.Item>
                </Form>
            </Modal>

            <Modal
                title="Táº¡o tiáº¿n trÃ¬nh lÃ m viá»c"
                open={createOpen}
                onCancel={() => setCreateOpen(false)}
                onOk={handleCreate}
                okText="Táº¡o"
                cancelText="Há»§y"
            >
                <Form layout="vertical" form={form}>
                    <Form.Item label="NgÃ y dá»ch vá»¥" name="serviceDate" rules={[{ required: true, message: "Chá»n ngÃ y" }]}>
                        <DatePicker className="w-full" />
                    </Form.Item>
                    <Form.Item label="Thá»i Äiá»m báº¯t Äáº§u" name="startTime" rules={[{ required: true, message: "Chá»n thá»i Äiá»m báº¯t Äáº§u" }]}>
                        <DatePicker showTime className="w-full" />
                    </Form.Item>
                    <Form.Item label="Tráº¡ng thÃ¡i hiá»n táº¡i">
                        <Tag>ChÆ°a báº¯t Äáº§u</Tag>
                    </Form.Item>

                    <Form.Item label="CÃ¡c má»c tiáº¿n Äá»" shouldUpdate>
                        <Form.List name="milestones">
                            {(fields, { add, remove }) => (
                                <div className="space-y-2">
                                    {fields.map((field) => (
                                        <Card key={field.key} size="small">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <Form.Item name={[field.name, "name"]} label="TÃªn má»c" rules={[{ required: true }]}>
                                                    <Input placeholder="TÃªn má»c" />
                                                </Form.Item>
                                                <Form.Item name={[field.name, "description"]} label="MÃ´ táº£" rules={[{ required: true }]}>
                                                    <Input placeholder="MÃ´ táº£" />
                                                </Form.Item>
                                            </div>
                                            <Button danger onClick={() => remove(field.name)}>XÃ³a</Button>
                                        </Card>
                                    ))}
                                    <Button onClick={() => add({ name: "", description: "" })}>ThÃªm má»c</Button>
                                </div>
                            )}
                        </Form.List>
                    </Form.Item>

                    <Form.Item label="Ghi chÃº" name="notes">
                        <TextArea rows={3} />
                    </Form.Item>
                </Form>
            </Modal>

            {/* Cancel Booking Modal */}
            <Modal
                title={
                    <div className="flex items-center gap-2">
                        <span className="text-red-500">â ï¸</span>
                        Há»§y lá»ch háº¹n
                    </div>
                }
                open={cancelOpen}
                onCancel={closeCancelBooking}
                footer={[
                    <Button key="cancel" onClick={closeCancelBooking}>
                        Há»§y
                    </Button>,
                    <Button
                        key="submit"
                        danger
                        onClick={submitCancelBooking}
                        loading={loading}
                    >
                        XÃ¡c nháº­n há»§y
                    </Button>
                ]}
                width={500}
            >
                <div className="space-y-4">
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div className="flex items-center gap-3">
                            <span className="text-red-500 text-xl">â ï¸</span>
                            <div>
                                <Text strong className="text-red-800 block">Cáº£nh bÃ¡o</Text>
                                <Text className="text-red-700">HÃ nh Äá»ng nÃ y khÃ´ng thá» hoÃ n tÃ¡c. Lá»ch háº¹n sáº½ bá» há»§y.</Text>
                            </div>
                        </div>
                    </div>

                    <div>
                        <Text strong className="block mb-2">
                            LÃ½ do há»§y (tÃ¹y chá»n)
                        </Text>
                        <TextArea
                            rows={3}
                            placeholder="LÃ½ do há»§y lá»ch háº¹n lÃ  gÃ¬?"
                            value={cancelReason}
                            onChange={(e) => setCancelReason(e.target.value)}
                        />
                    </div>
                </div>
            </Modal>
        </div>
    );
}
